<html>
<head>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>
<body>
	<input type="file" id="files" name="files[]" multiple />
<script type="text/javascript">

  var nodes = [];
  var links = [];

  function parseLines(l) {
    l.push("END");
    l.unshift("START");
    var nodeCount = {};
    var linkCount = {};

    for (var i = 0; i < l.length; i++) {
      if (nodeCount[l[i]] === undefined) {
        nodeCount[l[i]] = 1;
      } else {
        nodeCount[l[i]] += 1;
      }
      if (i + 1 < l.length) {

        var key = [l[i], l[i+1]];
        if (linkCount[key] === undefined) {
          linkCount[key] = 1;
        } else {
          linkCount[key] += 1;
        }
      }
    }
    var data = {};
    var index = {};
    var count = 0;
    for (key in nodeCount) {
      index[key] = count;
      count ++;
      nodes.push({
          "name":key,
          "count":nodeCount[key]
        }
      );
    }
    for (key in linkCount) {
      var pair = key.split(",");
      links.push({

        "source":index[pair[0]],
        "target":index[pair[1]],
        "count":linkCount[key]
      });      
    }
    render();
  }



  function handleFileSelect(evt) {
		var files = evt.target.files;
		var output = [];
		for (var i = 0, f; f = files[i]; i++) {
			var reader = new FileReader();
			reader.onload = function(e) {
				var lines = reader.result.split('\n');
        parseLines(lines);
			}
			reader.readAsText(f);
		}
	}

	document.getElementById('files').addEventListener('change', handleFileSelect, false);
  
  function render() { 
    var force = d3.layout.force()
      .charge(-700)
      .linkDistance(50)
      .size([500,500])
      .nodes(nodes)
      .links(links)
      .start();
       
      var svg = d3.select(document.body).append("svg")
      .attr("width", 500)
      .attr("height", 500);
       
      var nodeColor = d3.scale.category10();
      var radiusScale = d3.scale.log().domain([1,d3.max(nodes,function(d) { return d.count; })]).range([5,20]);
       
      var strokeScale = d3.scale.log().domain([1,d3.max(links,function(d) { return d.count; })]).range([1,20]);
      
      var chord = d3.svg.chord()
        .source(function(d) {return d.source})
        .target(function(d) {return d.target})
        .radius(20)
        .startAngle(1)
        .endAngle(1);

      var link = svg.selectAll("path.link")
        .data(links)
        .enter().append("path")
        .style('stroke', 'black')
        .style("stroke-width", function(d,i) {
          return strokeScale(d.count);
        });
      
      
    var node = svg.selectAll("circle.node")
    .data(nodes)
      .enter().append("circle")
      .attr("r", function(d) {
        return radiusScale(d.count);
      })
    .style("fill", "black" )
    .call(force.drag);

    node.append("title")
    .html(function(d) {return d.name;});

    force.on("tick", function() {
      link.attr("d", function(dx) {
        return chord(dx);
      });
     
    node.attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });
    })
  }

</script>
</body>
 
</html>
